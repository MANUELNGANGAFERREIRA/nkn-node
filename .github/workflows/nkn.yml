name: NKN Node Comercial

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  nkn:
    runs-on: ubuntu-latest

    steps:
      - name: Instalar dependÃªncias
        run: sudo apt update && sudo apt install unzip jq curl -y

      - name: Baixar binÃ¡rio
        run: |
          set -eux
          curl -fL https://commercial.nkn.org/downloads/nkn-commercial/linux-amd64.zip -o nkn.zip
          unzip -o nkn.zip
          if [ ! -f "linux-amd64/nkn-commercial" ]; then
            echo "Erro: binÃ¡rio nÃ£o encontrado"
            exit 1
          fi
          chmod +x linux-amd64/nkn-commercial
          mv linux-amd64/nkn-commercial .

      - name: Configurar nÃ³
        run: |
          mkdir -p ~/.nkn
          echo '{ "BeneficiaryAddr": "0x3a7710841239e9e7dad72e9cdbad295d4469e03e9b" }' > ~/.nkn/config.json

      - name: Executar nÃ³ e verificar mineraÃ§Ã£o
        run: |
          # Iniciar o nÃ³ em segundo plano
          ./nkn-commercial --logtostderr > nkn.log 2>&1 &
          sleep 30  # Esperar o nÃ³ inicializar

          # Verificar logs para ver se estÃ¡ minerando
          echo "ğŸ” Verificando logs..."
          if grep -q "mining block" nkn.log; then
            echo "âœ… NÃ³ estÃ¡ minerando blocos!"
          else
            echo "âŒ NÃ³ NÃƒO estÃ¡ minerando blocos (verifique logs)."
            cat nkn.log | tail -n 20
            exit 1
          fi

          # Verificar status via API (opcional)
          echo "ğŸ“¡ Verificando status do nÃ³..."
          curl -s http://localhost:30003/api/status | jq '.syncState, .currentBlockHeight'

          # Manter o nÃ³ rodando
          while sleep 300; do echo "ğŸ”„ Node ativo..."; done
