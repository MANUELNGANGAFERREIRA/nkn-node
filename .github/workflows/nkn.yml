name: NKN Node Comercial

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  nkn:
    runs-on: ubuntu-latest

    steps:
      - name: Instalar dependências
        run: sudo apt update && sudo apt install unzip jq curl -y

      - name: Baixar binário
        run: |
          set -eux
          curl -fL https://commercial.nkn.org/downloads/nkn-commercial/linux-amd64.zip -o nkn.zip
          unzip -o nkn.zip
          if [ ! -f "linux-amd64/nkn-commercial" ]; then
            echo "Erro: binário não encontrado"
            exit 1
          fi
          chmod +x linux-amd64/nkn-commercial
          mv linux-amd64/nkn-commercial .

      - name: Configurar nó
        run: |
          mkdir -p ~/.nkn
          echo '{ "BeneficiaryAddr": "0x3a7710841239e9e7dad72e9cdbad295d4469e03e9b" }' > ~/.nkn/config.json

      - name: Executar nó e verificar mineração
        run: |
          # Iniciar o nó em segundo plano
          ./nkn-commercial --logtostderr > nkn.log 2>&1 &
          sleep 30  # Esperar o nó inicializar

          # Verificar logs para ver se está minerando
          echo "🔍 Verificando logs..."
          if grep -q "mining block" nkn.log; then
            echo "✅ Nó está minerando blocos!"
          else
            echo "❌ Nó NÃO está minerando blocos (verifique logs)."
            cat nkn.log | tail -n 20
            exit 1
          fi

          # Verificar status via API (opcional)
          echo "📡 Verificando status do nó..."
          curl -s http://localhost:30003/api/status | jq '.syncState, .currentBlockHeight'

          # Manter o nó rodando
          while sleep 300; do echo "🔄 Node ativo..."; done
